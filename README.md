# Накопительная система лояльности «Гофермарт»

## Общие требования

Система представляет собой HTTP API со следующими требованиями к бизнес-логике:
- регистрация, аутентификация и авторизация пользователей;
- приём номеров заказов от зарегистрированных пользователей;
- учёт и ведение списка переданных номеров заказов зарегистрированного пользователя;
- учёт и ведение накопительного счёта зарегистрированного пользователя;
- проверка принятых номеров заказов через систему расчёта баллов лояльности;
- начисление за каждый подходящий номер заказа положенного вознаграждения на счёт лояльности пользователя.

## Абстрактная схема взаимодействия с системой

1. Пользователь регистрируется в системе лояльности «Гофермарт».
2. Пользователь совершает покупку в интернет-магазине «Гофермарт».
3. Заказ попадает в систему расчёта баллов лояльности.
4. Пользователь передаёт номер совершённого заказа в систему лояльности.
5. Система связывает номер заказа с пользователем и сверяет номер с системой расчёта баллов лояльности.
6. При наличии положительного расчёта баллов лояльности производится начисление баллов лояльности на счёт пользователя.
7. Пользователь списывает доступные баллы лояльности для частичной или полной оплаты последующих заказов в интернет-магазине «Гофермарт».

**Примечания:**
- пункт 2 представлен как гипотетический и не требует реализации в данной работе;
- пункт 3 реализован в системе расчёта баллов лояльности и не требует реализации в данной работе.

## Система расчёта баллов лояльности

Система расчёта баллов лояльности является внешним сервисом в доверенном контуре. Он работает по принципу чёрного ящика и недоступен для инспекции внешними клиентами. Система рассчитывает положенные баллы лояльности за совершённый заказ по сложным алгоритмам, которые могут меняться в любой момент времени.

Внешнему потребителю доступна только информация о количестве положенных за конкретный заказ баллов лояльности. Причины наличия или отсутствия начислений внешнему потребителю неизвестны.

## Сводное HTTP API

Накопительная система лояльности «Гофермарт» предоставляет следующие HTTP-хендлеры:

- `POST /api/user/register` — регистрация пользователя;
- `POST /api/user/login` — аутентификация пользователя;
- `POST /api/user/orders` — загрузка пользователем номера заказа для расчёта;
- `GET /api/user/orders` — получение списка загруженных пользователем номеров заказов, статусов их обработки и информации о начислениях;
- `GET /api/user/balance` — получение текущего баланса счёта баллов лояльности пользователя;
- `POST /api/user/balance/withdraw` — запрос на списание баллов с накопительного счёта в счёт оплаты нового заказа;
- `GET /api/user/withdrawals` — получение информации о выводе средств с накопительного счёта пользователем.

## Общие ограничения и требования

- хранилище данных — PostgreSQL;
- структура таблиц остаётся на усмотрение студента;
- типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаётся на усмотрение студента;
- клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
- клиент не обязан делать запросы соответственно нижеизложенной спецификации API, любая проверка запроса остаётся на усмотрение студента;
- формат и алгоритм проверки аутентификации и авторизации пользователя остаётся на усмотрение студента;
- номера заказов уникальны и никогда не повторяются;
- номер заказа может быть принят в обработку только один раз от одного пользователя;
- номер заказа может не иметь никакого начисления;
- вознаграждение начисляется и тратится в виртуальных баллах из расчёта 1 балл = 1 единица местной валюты.

---


## Конфигурирование сервиса

Конфигурация читается из **переменных окружения** и **CLI-флагов**.

- **Приоритет**: флаги `-a/-d/-r` перекрывают env-переменные.

### Адрес сервиса

- **`RUN_ADDRESS`**: адрес и порт HTTP-сервера (например `localhost:8080`).
  - **default**: если не задан — используется `":" + PORT`, где `PORT` из env (см. ниже).
- **`PORT`**: порт для дефолтного `RUN_ADDRESS`.
  - **default**: `8080` (если `RUN_ADDRESS` не задан).
- **`-a`**: `service run address` (перекрывает `RUN_ADDRESS`).

### PostgreSQL

- **`DATABASE_URI`**: строка подключения к PostgreSQL.
  - **default**: `postgres://localhost:5432/postgres?sslmode=disable` (если `DATABASE_URI` пустой).
- **`-d`**: `database uri` (перекрывает `DATABASE_URI`).

Пул соединений:

- **`DB_MAX_OPEN_CONNS`** (int) — **default**: `100`
- **`DB_MAX_IDLE_CONNS`** (int) — **default**: `25`
- **`DB_CONN_MAX_LIFETIME`** (seconds) — **default**: `300` (5 минут)
- **`DB_CONN_MAX_IDLE_TIME`** (seconds) — **default**: `60` (1 минута)
- **`DB_QUERY_TIMEOUT`** (seconds) — **default**: `3`

### Accrual

- **`ACCRUAL_SYSTEM_ADDRESS`**: адрес сервиса начислений (например `http://localhost:8081`).
  - если пустой — используется mock accrual-клиент.
- **`-r`**: `accrual system address` (перекрывает `ACCRUAL_SYSTEM_ADDRESS`).

### JWT / Auth

- **`JWT_SECRET`**: секрет для подписи JWT.
  - если пустой — генерируется случайный при старте.
- **`JWT_TTL_SECONDS`** (seconds): TTL JWT.
  - **default**: `86400` (24 часа)

Rate limiting (только для `/api/user/register` и `/api/user/login`):

- **`AUTH_RATE_LIMIT_RPS`** (int) — **default**: `100`
- **`AUTH_RATE_LIMIT_BURST`** (int) — **default**: `20`

### Логирование

- **`LOG_LEVEL`**: уровень логирования (например `debug`, `info`, `warn`, `error`), пробелы по краям обрезаются.
- **`LOG_HTTP_BODIES`** (bool): логировать тела запросов/ответов (для отладки).
  - значения: `true/1/yes/on` или `false/0/no/off`
  - **default**: `false`

## Архитектура проекта

Проект реализован с использованием Clean Architecture:

- **Domain Layer** (`internal/domain/*`): бизнес-логика, модели, репозитории (интерфейсы), сервисы, use cases
- **Adapter Layer** (`internal/adapter/*`): реализации репозиториев (PostgreSQL), внешние клиенты (accrual), JWT токены
- **Controller Layer** (`internal/controller/httpapi`): HTTP-хендлеры, middleware, роутинг (Gin)
- **App Layer** (`internal/app`): wiring зависимостей, запуск приложения
- **Config** (`internal/config`): конфигурация (флаги + env)

### Технологический стек

- Go 1.23+
- PostgreSQL (драйвер: `database/sql` + `github.com/lib/pq`)
- Gin Web Framework
- JWT аутентификация (`cristalhq/jwt`)
- Миграции: `golang-migrate/migrate`
- Логирование: `rs/zerolog`
- Decimal: `shopspring/decimal`
- HTTP клиент: `net/http` (для accrual интеграции)
---
